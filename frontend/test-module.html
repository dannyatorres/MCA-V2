<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Service Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            background: #28a745;
        }
        .success:hover {
            background: #218838;
        }
        #output {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª API Service Module Test</h1>
        <p>Click the buttons below to test the new API service:</p>

        <button onclick="testGet()">Test GET /api/conversations</button>
        <button onclick="testNews()" class="success">Test GET /api/news</button>
        <button onclick="testFormatters()" style="background: #6f42c1;">Test Formatters & Validators</button>
        <button onclick="testLookups()" style="background: #fd7e14;">Test Lookups Manager</button>
        <button onclick="testForms()" style="background: #e83e8c;">Test Forms Manager</button>
        <button onclick="testLeadManager()" style="background: #20c997;">Test Lead Manager</button>
        <button onclick="clearOutput()">Clear Output</button>

        <div id="output"></div>
    </div>

    <script type="module">
        import { ApiService } from './js/api.js';
        import { Formatters, Validators } from './js/formatters.js';
        import { LookupManager } from './js/lookups.js';
        import { FormManager } from './js/forms.js';
        import { LeadManager } from './js/leads.js';

        // Make them available globally for button clicks
        window.ApiService = ApiService;
        window.Formatters = Formatters;
        window.Validators = Validators;
        window.LookupManager = LookupManager;
        window.FormManager = FormManager;
        window.LeadManager = LeadManager;

        // Test GET request
        window.testGet = async function() {
            const output = document.getElementById('output');
            output.innerHTML = 'â³ Testing GET /api/conversations...\n';

            try {
                const data = await ApiService.get('/api/conversations');
                output.innerHTML += `\nâœ… SUCCESS!\n\n`;
                output.innerHTML += `Response:\n${JSON.stringify(data, null, 2)}`;

                const status = document.createElement('div');
                status.className = 'status success';
                status.textContent = `âœ… ApiService.get() is working! Received ${Array.isArray(data) ? data.length : 'data'} items.`;
                output.appendChild(status);
            } catch (error) {
                output.innerHTML += `\nâŒ FAILED!\n\n`;
                output.innerHTML += `Error: ${error.message}\n${error.stack}`;

                const status = document.createElement('div');
                status.className = 'status error';
                status.textContent = `âŒ Test failed: ${error.message}`;
                output.appendChild(status);
            }
        };

        // Test News API
        window.testNews = async function() {
            const output = document.getElementById('output');
            output.innerHTML = 'â³ Testing GET /api/news...\n';

            try {
                const data = await ApiService.get('/api/news');
                output.innerHTML += `\nâœ… SUCCESS!\n\n`;
                output.innerHTML += `Response:\n${JSON.stringify(data, null, 2)}`;

                const status = document.createElement('div');
                status.className = 'status success';
                status.textContent = `âœ… News API is working! Received ${data.data ? data.data.length : 0} news items.`;
                output.appendChild(status);
            } catch (error) {
                output.innerHTML += `\nâŒ FAILED!\n\n`;
                output.innerHTML += `Error: ${error.message}\n${error.stack}`;

                const status = document.createElement('div');
                status.className = 'status error';
                status.textContent = `âŒ Test failed: ${error.message}`;
                output.appendChild(status);
            }
        };

        // Clear output
        window.clearOutput = function() {
            document.getElementById('output').innerHTML = '';
        };

        // Test Formatters & Validators
        window.testFormatters = function() {
            const output = document.getElementById('output');
            output.innerHTML = 'ğŸ§ª Testing Formatters & Validators...\n\n';

            let passed = 0;
            let failed = 0;

            // Test 1: Phone Formatting
            const rawPhone = "1234567890";
            const formattedPhone = Formatters.phone(rawPhone);
            output.innerHTML += `ğŸ“± Phone Formatter:\n`;
            output.innerHTML += `   Input: "${rawPhone}"\n`;
            output.innerHTML += `   Output: "${formattedPhone}"\n`;

            if (formattedPhone === '(123) 456-7890') {
                output.innerHTML += `   âœ… PASSED\n\n`;
                passed++;
            } else {
                output.innerHTML += `   âŒ FAILED (Expected: "(123) 456-7890")\n\n`;
                failed++;
            }

            // Test 2: SSN Formatting
            const rawSSN = "123456789";
            const formattedSSN = Formatters.ssn(rawSSN);
            output.innerHTML += `ğŸ” SSN Formatter:\n`;
            output.innerHTML += `   Input: "${rawSSN}"\n`;
            output.innerHTML += `   Output: "${formattedSSN}"\n`;

            if (formattedSSN === '123-45-6789') {
                output.innerHTML += `   âœ… PASSED\n\n`;
                passed++;
            } else {
                output.innerHTML += `   âŒ FAILED (Expected: "123-45-6789")\n\n`;
                failed++;
            }

            // Test 3: EIN Formatting
            const rawEIN = "123456789";
            const formattedEIN = Formatters.ein(rawEIN);
            output.innerHTML += `ğŸ¢ EIN Formatter:\n`;
            output.innerHTML += `   Input: "${rawEIN}"\n`;
            output.innerHTML += `   Output: "${formattedEIN}"\n`;

            if (formattedEIN === '12-3456789') {
                output.innerHTML += `   âœ… PASSED\n\n`;
                passed++;
            } else {
                output.innerHTML += `   âŒ FAILED (Expected: "12-3456789")\n\n`;
                failed++;
            }

            // Test 4: Currency Formatting
            const rawCurrency = 1000;
            const formattedCurrency = Formatters.currency(rawCurrency);
            output.innerHTML += `ğŸ’° Currency Formatter:\n`;
            output.innerHTML += `   Input: ${rawCurrency}\n`;
            output.innerHTML += `   Output: "${formattedCurrency}"\n`;

            if (formattedCurrency === '$1,000') {
                output.innerHTML += `   âœ… PASSED\n\n`;
                passed++;
            } else {
                output.innerHTML += `   âŒ FAILED (Expected: "$1,000")\n\n`;
                failed++;
            }

            // Test 5: Strip Formatter
            const formatted = "(123) 456-7890";
            const stripped = Formatters.strip(formatted);
            output.innerHTML += `ğŸ§¹ Strip Formatter:\n`;
            output.innerHTML += `   Input: "${formatted}"\n`;
            output.innerHTML += `   Output: "${stripped}"\n`;

            if (stripped === '1234567890') {
                output.innerHTML += `   âœ… PASSED\n\n`;
                passed++;
            } else {
                output.innerHTML += `   âŒ FAILED (Expected: "1234567890")\n\n`;
                failed++;
            }

            // Test 6: Email Validation
            const badEmail = "test@";
            const goodEmail = "test@example.com";
            output.innerHTML += `ğŸ“§ Email Validator:\n`;
            output.innerHTML += `   Bad Email: "${badEmail}" -> ${Validators.email(badEmail)}\n`;
            output.innerHTML += `   Good Email: "${goodEmail}" -> ${Validators.email(goodEmail)}\n`;

            if (!Validators.email(badEmail) && Validators.email(goodEmail)) {
                output.innerHTML += `   âœ… PASSED\n\n`;
                passed++;
            } else {
                output.innerHTML += `   âŒ FAILED\n\n`;
                failed++;
            }

            // Test 7: Phone Validation
            const badPhone = "123";
            const goodPhone = "(123) 456-7890";
            output.innerHTML += `ğŸ“ Phone Validator:\n`;
            output.innerHTML += `   Bad Phone: "${badPhone}" -> ${Validators.phone(badPhone)}\n`;
            output.innerHTML += `   Good Phone: "${goodPhone}" -> ${Validators.phone(goodPhone)}\n`;

            if (!Validators.phone(badPhone) && Validators.phone(goodPhone)) {
                output.innerHTML += `   âœ… PASSED\n\n`;
                passed++;
            } else {
                output.innerHTML += `   âŒ FAILED\n\n`;
                failed++;
            }

            // Test 8: Required Validator
            const empty = "";
            const filled = "data";
            output.innerHTML += `âœ… Required Validator:\n`;
            output.innerHTML += `   Empty: "${empty}" -> ${Validators.required(empty)}\n`;
            output.innerHTML += `   Filled: "${filled}" -> ${Validators.required(filled)}\n`;

            if (!Validators.required(empty) && Validators.required(filled)) {
                output.innerHTML += `   âœ… PASSED\n\n`;
                passed++;
            } else {
                output.innerHTML += `   âŒ FAILED\n\n`;
                failed++;
            }

            // Summary
            const status = document.createElement('div');
            status.className = failed === 0 ? 'status success' : 'status error';
            status.innerHTML = `<strong>Test Results:</strong> ${passed} passed, ${failed} failed`;
            output.appendChild(status);
        };

        // Test Lookups Manager
        window.testLookups = async function() {
            const output = document.getElementById('output');
            output.innerHTML = 'ğŸ§ª Testing Lookups Manager...\n\n';

            // Create test dropdown elements
            const testSelects = [
                { id: 'businessState', type: 'States' },
                { id: 'entityType', type: 'Entity Types' },
                { id: 'industryType', type: 'Industry Types' },
                { id: 'leadSource', type: 'Lead Sources' },
                { id: 'assignedTo', type: 'Users' }
            ];

            testSelects.forEach(({ id, type }) => {
                let select = document.getElementById(id);
                if (!select) {
                    select = document.createElement('select');
                    select.id = id;
                    select.style.display = 'none';
                    document.body.appendChild(select);
                }
            });

            try {
                output.innerHTML += 'â³ Initializing LookupManager...\n';
                await LookupManager.init();
                output.innerHTML += 'âœ… Initialization complete\n\n';

                let passed = 0;
                let failed = 0;

                testSelects.forEach(({ id, type }) => {
                    const select = document.getElementById(id);
                    const optionCount = select ? select.options.length : 0;

                    output.innerHTML += `ğŸ“‹ ${type} (${id}):\n`;
                    output.innerHTML += `   Options populated: ${optionCount}\n`;

                    if (optionCount > 1) {
                        output.innerHTML += `   âœ… PASSED\n\n`;
                        passed++;
                    } else {
                        output.innerHTML += `   âŒ FAILED (Expected > 1 option)\n\n`;
                        failed++;
                    }
                });

                // Show sample data
                output.innerHTML += '\nğŸ“Š Sample Data:\n';
                output.innerHTML += `   States: ${LookupManager.data.states.length} items\n`;
                output.innerHTML += `   Entity Types: ${LookupManager.data.entityTypes.length} items\n`;
                output.innerHTML += `   Industry Types: ${LookupManager.data.industryTypes.length} items\n`;
                output.innerHTML += `   Lead Sources: ${LookupManager.data.leadSources.length} items\n`;
                output.innerHTML += `   Users: ${LookupManager.data.users.length} items\n\n`;

                const status = document.createElement('div');
                status.className = failed === 0 ? 'status success' : 'status error';
                status.innerHTML = `<strong>Test Results:</strong> ${passed} passed, ${failed} failed`;
                output.appendChild(status);

            } catch (error) {
                output.innerHTML += `\nâŒ Test Failed: ${error.message}\n`;
                const status = document.createElement('div');
                status.className = 'status error';
                status.textContent = `âŒ Lookups test failed: ${error.message}`;
                output.appendChild(status);
            }
        };

        // Test Forms Manager
        window.testForms = function() {
            const output = document.getElementById('output');
            output.innerHTML = 'ğŸ§ª Testing Forms Manager...\n\n';

            let passed = 0;
            let failed = 0;

            // Test 1: Validation Logic
            output.innerHTML += 'ğŸ“‹ Test 1: Validation Logic\n';
            const invalidData = { companyName: '', primaryPhone: '' };
            const errors = FormManager.validateNewLead(invalidData);

            output.innerHTML += `   Invalid data: ${JSON.stringify(invalidData)}\n`;
            output.innerHTML += `   Errors caught: ${errors.length}\n`;
            output.innerHTML += `   Error messages: ${errors.join(', ')}\n`;

            if (errors.length === 2 && errors.includes('Company Name is required') && errors.includes('Primary Phone is required')) {
                output.innerHTML += `   âœ… PASSED\n\n`;
                passed++;
            } else {
                output.innerHTML += `   âŒ FAILED (Expected 2 errors)\n\n`;
                failed++;
            }

            // Test 2: Validation with Valid Data
            output.innerHTML += 'ğŸ“‹ Test 2: Valid Data Validation\n';
            const validData = {
                companyName: 'Test Corp',
                primaryPhone: '1234567890',
                businessEmail: 'test@example.com'
            };
            const validErrors = FormManager.validateNewLead(validData);

            output.innerHTML += `   Valid data: ${JSON.stringify(validData)}\n`;
            output.innerHTML += `   Errors caught: ${validErrors.length}\n`;

            if (validErrors.length === 0) {
                output.innerHTML += `   âœ… PASSED (No errors for valid data)\n\n`;
                passed++;
            } else {
                output.innerHTML += `   âŒ FAILED (Should have no errors)\n\n`;
                failed++;
            }

            // Test 3: Email Validation
            output.innerHTML += 'ğŸ“§ Test 3: Email Validation\n';
            const invalidEmail = {
                companyName: 'Test Corp',
                primaryPhone: '1234567890',
                businessEmail: 'invalid-email'
            };
            const emailErrors = FormManager.validateNewLead(invalidEmail);

            output.innerHTML += `   Data with bad email: ${invalidEmail.businessEmail}\n`;
            output.innerHTML += `   Errors: ${emailErrors.join(', ')}\n`;

            if (emailErrors.includes('Invalid Business Email')) {
                output.innerHTML += `   âœ… PASSED (Bad email detected)\n\n`;
                passed++;
            } else {
                output.innerHTML += `   âŒ FAILED (Should catch bad email)\n\n`;
                failed++;
            }

            // Test 4: Form Population
            output.innerHTML += 'ğŸ–Šï¸ Test 4: Form Population\n';

            // Create dummy inputs
            const dummyInputs = [
                { id: 'editCompanyName', expected: 'Test Corporation' },
                { id: 'editDbaName', expected: 'TestCo' },
                { id: 'editPrimaryPhone', expected: '(123) 456-7890' }
            ];

            dummyInputs.forEach(({ id, expected }) => {
                const input = document.createElement('input');
                input.id = id;
                input.style.display = 'none';
                document.body.appendChild(input);
            });

            const mockConversation = {
                business_name: 'Test Corporation',
                dba_name: 'TestCo',
                lead_phone: '1234567890'
            };

            FormManager.populateEditForm(mockConversation);

            let populateSuccess = true;
            dummyInputs.forEach(({ id, expected }) => {
                const input = document.getElementById(id);
                const value = input.value;
                output.innerHTML += `   ${id}: "${value}"\n`;
                if (value !== expected) populateSuccess = false;
                document.body.removeChild(input); // Cleanup
            });

            if (populateSuccess) {
                output.innerHTML += `   âœ… PASSED (All fields populated correctly)\n\n`;
                passed++;
            } else {
                output.innerHTML += `   âŒ FAILED (Fields not populated correctly)\n\n`;
                failed++;
            }

            // Test 5: Data Scraping Simulation
            output.innerHTML += 'ğŸ“Š Test 5: Data Scraping (Simulated)\n';

            // Create and populate test inputs
            const testFields = [
                { id: 'editCompanyName', value: 'Acme Corp' },
                { id: 'editBusinessPhone', value: '(555) 123-4567' },
                { id: 'editRequestedAmount', value: '$100,000' }
            ];

            testFields.forEach(({ id, value }) => {
                const input = document.createElement('input');
                input.id = id;
                input.value = value;
                input.style.display = 'none';
                document.body.appendChild(input);
            });

            // Create radio button for marketing
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'editMarketingNotification';
            radio.value = 'BOTH';
            radio.checked = true;
            radio.style.display = 'none';
            document.body.appendChild(radio);

            const scrapedData = FormManager.getEditLeadData();

            output.innerHTML += `   Company: ${scrapedData.business_name}\n`;
            output.innerHTML += `   Phone (stripped): ${scrapedData.business_phone}\n`;
            output.innerHTML += `   Amount (stripped): ${scrapedData.requested_amount}\n`;
            output.innerHTML += `   Marketing Text: ${scrapedData.marketing_opt_text}\n`;
            output.innerHTML += `   Marketing Email: ${scrapedData.marketing_opt_email}\n`;

            const scrapingSuccess =
                scrapedData.business_name === 'Acme Corp' &&
                scrapedData.business_phone === '5551234567' &&
                scrapedData.requested_amount === '100000' &&
                scrapedData.marketing_opt_text === true &&
                scrapedData.marketing_opt_email === true;

            // Cleanup
            testFields.forEach(({ id }) => {
                const input = document.getElementById(id);
                if (input) document.body.removeChild(input);
            });
            if (radio.parentNode) document.body.removeChild(radio);

            if (scrapingSuccess) {
                output.innerHTML += `   âœ… PASSED (Data scraped and formatted correctly)\n\n`;
                passed++;
            } else {
                output.innerHTML += `   âŒ FAILED (Data not scraped correctly)\n\n`;
                failed++;
            }

            // Summary
            const status = document.createElement('div');
            status.className = failed === 0 ? 'status success' : 'status error';
            status.innerHTML = `<strong>Test Results:</strong> ${passed} passed, ${failed} failed`;
            output.appendChild(status);
        };

        // Test Lead Manager
        window.testLeadManager = async function() {
            const output = document.getElementById('output');
            output.innerHTML = 'ğŸ§ª Testing Lead Manager...\n';

            // We will try to fetch a fake ID to see if the logic holds together
            // (It will likely fail network-wise, but verify the function executes)
            try {
                output.innerHTML += '\nâ³ Attempting to fetch lead with ID 999999...\n';
                await LeadManager.getById('999999');

                // If we get here, either the lead exists or something unexpected happened
                output.innerHTML += '\nâœ… Request completed (unexpected success)\n';

                const status = document.createElement('div');
                status.className = 'status success';
                status.textContent = 'âœ… LeadManager is linked and communicating with API!';
                output.appendChild(status);

            } catch (e) {
                // We EXPECT an error here because ID 999999 likely doesn't exist
                // But if the error message is from our ApiService, we know it works.
                output.innerHTML += '\nâœ… LeadManager successfully connected to API Service!\n';
                output.innerHTML += `   (Error was expected: ${e.message})\n\n`;

                output.innerHTML += 'ğŸ“‹ Available Methods:\n';
                output.innerHTML += '   â€¢ LeadManager.create(leadData)\n';
                output.innerHTML += '   â€¢ LeadManager.update(id, leadData)\n';
                output.innerHTML += '   â€¢ LeadManager.getById(id)\n';
                output.innerHTML += '   â€¢ LeadManager.archive(id)\n';
                output.innerHTML += '   â€¢ LeadManager.delete(id)\n';
                output.innerHTML += '   â€¢ LeadManager.clone(id)\n';

                const status = document.createElement('div');
                status.className = 'status success';
                status.textContent = 'âœ… LeadManager is linked and ready!';
                output.appendChild(status);
            }
        };

        console.log('âœ… API Service Test Page Loaded');
        console.log('ğŸ”§ ApiService available in window.ApiService');
        console.log('ğŸ”§ Formatters available in window.Formatters');
        console.log('ğŸ”§ Validators available in window.Validators');
        console.log('ğŸ”§ LookupManager available in window.LookupManager');
        console.log('ğŸ”§ FormManager available in window.FormManager');
        console.log('ğŸ”§ LeadManager available in window.LeadManager');
    </script>
</body>
</html>
