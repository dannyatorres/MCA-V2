# Puppeteer PDF Generation - Deployment Guide

## Overview
This application uses Puppeteer (headless Chrome) for server-side PDF generation. This provides:
- ‚úÖ Vector-based PDFs (crisp, selectable text)
- ‚úÖ No CORS or canvas tainting issues
- ‚úÖ Consistent rendering across all environments
- ‚úÖ Support for complex CSS and external images

## Production Requirements

### 1. System Dependencies

Puppeteer requires Chrome/Chromium libraries that may not be installed by default on Linux servers.

#### Docker
Add to your `Dockerfile`:
```dockerfile
RUN apt-get update && apt-get install -y \
    chromium \
    chromium-sandbox \
    fonts-liberation \
    libnss3 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libxcomposite1 \
    libxdamage1 \
    libxrandr2 \
    libgbm1 \
    libpango-1.0-0 \
    libcairo2 \
    libasound2 \
    && rm -rf /var/lib/apt/lists/*
```

#### Heroku
Add the Puppeteer buildpack:
```bash
heroku buildpacks:add jontewks/puppeteer
heroku buildpacks:add heroku/nodejs
```

Or add to your `app.json`:
```json
{
  "buildpacks": [
    {
      "url": "https://github.com/jontewks/puppeteer-heroku-buildpack"
    },
    {
      "url": "heroku/nodejs"
    }
  ]
}
```

#### AWS EC2 / Ubuntu
```bash
sudo apt-get update
sudo apt-get install -y chromium-browser chromium-codecs-ffmpeg
```

### 2. Environment Variables

Ensure these are set:
```bash
AWS_ACCESS_KEY_ID=your_key
AWS_SECRET_ACCESS_KEY=your_secret
AWS_REGION=us-east-1
S3_DOCUMENTS_BUCKET=your_bucket_name
```

### 3. Memory Considerations

Puppeteer can use 100-300MB per browser instance. The code properly closes browsers after use, but ensure your server has adequate RAM:
- **Minimum:** 512MB
- **Recommended:** 1GB+

### 4. Puppeteer Configuration

The code uses production-ready launch arguments:
```javascript
await puppeteer.launch({
    headless: 'new',
    args: [
        '--no-sandbox',              // Required for Docker/root
        '--disable-setuid-sandbox',  // Required for Docker/root
        '--disable-dev-shm-usage',   // Prevents /dev/shm memory issues
        '--disable-gpu'              // Not needed for PDF generation
    ]
});
```

### 5. Font Consistency

The HTML template uses Google Fonts (Open Sans) to ensure consistent rendering:
```html
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
```

This means PDFs will look identical regardless of which fonts are installed on the server.

### 6. Page Break Control

The template uses CSS to prevent awkward page breaks:
```css
.header {
    page-break-after: avoid; /* Header stays with content */
}
.section {
    page-break-inside: avoid; /* Sections don't split across pages */
}
```

## Testing in Production

After deployment, test the PDF generation:

1. Create or edit a lead with complete information
2. Click "Generate PDF"
3. Check server logs for Puppeteer output:
   ```
   üöÄ Starting Puppeteer PDF generation...
   üìù HTML template populated
   üåê Puppeteer browser launched
   ‚úÖ HTML content loaded in Puppeteer
   üìÑ PDF generated by Puppeteer
   ‚òÅÔ∏è PDF uploaded to S3
   üíæ PDF metadata saved to database
   üîí Puppeteer browser closed
   ```

## Troubleshooting

### Error: "Failed to launch the browser process"
**Solution:** Missing Chrome dependencies. Install the required libraries (see Docker/Ubuntu sections above).

### Error: "Navigation timeout"
**Solution:** Slow network or large images in template. Increase timeout in `page.setContent()`:
```javascript
await page.setContent(htmlContent, {
    waitUntil: 'networkidle0',
    timeout: 30000 // 30 seconds
});
```

### Error: "spawn ENOMEM"
**Solution:** Not enough memory. Add `--disable-dev-shm-usage` flag (already included) or increase server RAM.

### PDF renders but fonts look different
**Solution:** Google Fonts may be blocked or slow. Consider self-hosting fonts or using system fonts.

## Performance Optimization

For high-volume PDF generation (100+ per hour), consider:

1. **Browser Reuse:** Keep one browser instance running and create new pages for each PDF
2. **Queue System:** Use a job queue (Bull, BeeQueue) to prevent concurrent browser launches
3. **Dedicated Service:** Move PDF generation to a separate microservice

## Cost Considerations

- **AWS Lambda:** Puppeteer works but requires custom layers (150MB+)
- **AWS EC2:** t3.small or larger recommended
- **Heroku:** Standard dyno or higher
- **CPU Usage:** Each PDF takes 2-5 seconds CPU time

## Security Notes

- PDFs contain sensitive information (SSN, Tax ID) - ensure S3 buckets are private
- The `--no-sandbox` flag is required in Docker but reduces isolation
- Consider running Puppeteer in a separate, isolated container for maximum security
